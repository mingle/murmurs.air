<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<link rel="stylesheet" href="css/murmurs.css" type="text/css" media="screen" charset="utf-8" />
	<title>Mingle Murmurs</title>
	<!-- The AIR aliases definitions -->
	<script src="vendor/air/AIRAliases.js" type="text/javascript" charset="utf-8"></script>

  <script src="vendor/air/AIRIntrospector.js" type="text/javascript" charset="utf-8"></script>
	<script src="vendor/jquery/jquery-1.3.2.js" type="text/javascript" charset="utf-8"></script>
	<script src="lib/utils.js" type="text/javascript" charset="utf-8"></script>
	
	<script type="text/javascript" charset="utf-8">
   
   Murmur = function() {}
   
   Murmur.parse = function(xml) {
     var murmur = new Murmur()
     murmur.content = $("body", xml).text()
     murmur.created_at = $("created_at", xml).text()

     murmur.author = {
       name: $("author name", xml).text(),
       icon_path: Preference.host() + $("author icon_path", xml).text()
     }
     return murmur
	 }
	 
	 MurmurView = function(murmur) {	   
	   this.render = function(container) {
       var arrow = $('<span class="arrow-to-right"><span></span></span>')
	     var author = $('<span class="author"></span>').text(murmur.author.name)
       var content = $('<div class="content"></div>').text(murmur.content)
       var created_at = $('<span class="created-at"></span>').text(murmur.created_at)
       var body = $('<div class="body"></div>').append(arrow).append(created_at).append(author).append(content)
       var icon = $('<div class="icon-wrapper"><img class="icon" src="' + murmur.author.icon_path + '"></img>')
       var murmur_element = $('<div class="murmur"></div>').append(icon).append(body)
       container.append(murmur_element)
     }
   }
   
   StatusBar = function() {
     var element = function() {
       return $('#status')
     }
     
     return {
       text: function(t) {
         element().text(t)
       }
     }
   }()
   
   $(document).ready(function() {
     var targetMenu = air.NativeApplication.nativeApplication.menu; 
     
     var murMenu = targetMenu.addItem(new air.NativeMenuItem("Mur"));
     murMenu.submenu = new air.NativeMenu();
     var preference = murMenu.submenu.addItem(new air.NativeMenuItem("Preference"))
     preference.addEventListener(air.Event.SELECT, function() {
       var win = window.open("app/views/preference.html", "Preference")
       win.resizeTo(400, 250)
     })
     var refresh = murMenu.submenu.addItem(new air.NativeMenuItem("refresh"))
     refresh.addEventListener(air.Event.SELECT, refreshMurmur)

   })
   
   
   function refreshMurmur() {
     if( typeof Preference === 'undefined' ) return
     StatusBar.text("loading...")

     $.ajax({ 
       dataType: 'xml',
       url: Preference.api_url(),

       beforeSend: function(xhr) {
         xhr.setRequestHeader('Authorization', Preference.base_auth_token())
       },
   
       success: function(xml) {
         StatusBar.text("")
         $("#container").html("")
         
         $("murmurs murmur", xml).each(function(){
           new MurmurView(Murmur.parse(this)).render($("#container"))
         })
        
       }
      })
   }
	 
	 $(document).ready(function() {
	   refreshMurmur()
	 })
	 
	</script>
	<body>
	  <div id="container">
	  </div>
	  
	  <div id="status_bar">
	    <button>post</button>
	    <span id="status"></span>
	  </div>
  </body>
</html>